document.addEventListener('DOMContentLoaded', () => {
  // Genealogical data for Порошин Николай Михайлович (2006)
  // Aggregated branches: Titovy, Atkiny, and Порошины
  const data = {
    name: 'Порошин Николай Михайлович (2006)',
    children: [
      {
        name: 'Титова Елизавета Александровна (урожд. Савельева)',
        years: '25.10.1898–13.04.1972',
        profession: '',
        residence: '',
        children: [
          {
            name: 'Титов Пётр Михайлович',
            years: '1928–',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Титов Степан Михайлович',
            years: '1930–',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Титова Нина Михайловна',
            years: '20.06.1933–',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Титов Виктор Михайлович',
            years: '25.04.1942–07.03.1991',
            profession: 'Военнослужащий (Тихоокеанский флот)',
            residence: '',
            children: [
              {
                name: 'Титов Евгений Викторович',
                years: '21.10.1973–15.08.1991',
                profession: '',
                residence: ''
              }
            ]
          },
          {
            name: 'Титов Александр (Леонид) Михайлович',
            years: '20.06.1933–01.10.2002',
            profession: '',
            residence: 'Матвеевка (выписано как место рождения); позднее Новосибирск',
            children: [
              {
                name: 'Порошина Елена Александровна',
                years: '–',
                profession: '',
                residence: 'Новосибирск',
                children: [
                  {
                    name: 'Порошин Максим Михайлович',
                    years: '–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  },
                  {
                    name: 'Порошин Евгений Михайлович',
                    years: '–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  },
                  {
                    name: 'Порошин Николай Михайлович',
                    years: '2006–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        name: 'Аткин Иван Осипович',
        years: '13.06.1908–1954 (или 1952)',
        profession: 'Шофёр, рядовой РККА (ВОВ; фронтовой водитель «Катюш»)',
        residence: 'с. Пичпанда, Мордовия; позднее Новосибирск',
        children: [
          {
            name: 'Аткин Фёдор Иванович',
            years: '02.09.1928–2012',
            profession: '',
            residence: 'с. Пичпанда, Мордовия',
            children: []
          },
          {
            name: 'Горленко Екатерина Ивановна (урожд. Аткина)',
            years: '21.08.1930–14.09.2000',
            profession: '',
            residence: 'Матвеевка (Новосибирск)',
            children: []
          },
          {
            name: 'Аткин Виталий (Виктор) Иванович',
            years: '1932–1933',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Аткина Елизавета Ивановна',
            years: '1932–1933',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Ведерникова Мария Ивановна (урожд. Аткина)',
            years: '02.03.1934–14.02.2010',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Титова Ольга Ивановна (урожд. Аткина)',
            years: '05.08.1937–',
            profession: 'Сельхозработница (ферма, поле)',
            residence: 'рожд. с. Пичпанда (Мордовия); проживала Новосибирск, пос. Матвеевка',
            children: [
              {
                name: 'Порошина Елена Александровна',
                years: '–',
                profession: '',
                residence: 'Новосибирск',
                children: [
                  {
                    name: 'Порошин Максим Михайлович',
                    years: '–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  },
                  {
                    name: 'Порошин Евгений Михайлович',
                    years: '–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  },
                  {
                    name: 'Порошин Николай Михайлович',
                    years: '2006–',
                    profession: '',
                    residence: 'Новосибирск',
                    children: []
                  }
                ]
              }
            ]
          },
          {
            name: 'Аткин Михаил Иванович',
            years: '1948–1985',
            profession: '',
            residence: '',
            children: []
          },
          {
            name: 'Волхонская Людмила Ивановна (урожд. Аткина)',
            years: '1952–',
            profession: '',
            residence: 'большую часть жизни — г. Кемерово; позднее Краснодар',
            children: [
              {
                name: 'Волхонский Сергей',
                years: '1982–',
                profession: '',
                residence: '',
                children: []
              },
              {
                name: 'Волхонский Павел',
                years: '1984–',
                profession: '',
                residence: '',
                children: []
              }
            ]
          }
        ]
      },
      {
        name: 'Порошин Михаил Юрьевич',
        years: '–',
        profession: '',
        residence: 'Новосибирск',
        children: [
          {
            name: 'Порошин Максим Михайлович',
            years: '–',
            profession: '',
            residence: 'Новосибирск',
            children: []
          },
          {
            name: 'Порошин Евгений Михайлович',
            years: '–',
            profession: '',
            residence: 'Новосибирск',
            children: []
          },
          {
            name: 'Порошин Николай Михайлович',
            years: '2006–',
            profession: '',
            residence: 'Новосибирск',
            children: []
          }
        ]
      }
    ]
  };

  const tooltip = d3.select('#tooltip');
  const container = document.getElementById('tree-container');
  const width = container.clientWidth || window.innerWidth;
  const height = container.clientHeight || window.innerHeight;

  const svg = d3.select('#tree-container')
    .append('svg')
    .attr('viewBox', [0, 0, width, height])
    .attr('width', '100%')
    .attr('height', '100%')
    .append('g')
    .attr('transform', 'translate(40,40)');

  const root = d3.hierarchy(data);
  const treeLayout = d3.tree().size([height - 80, width - 160]);
  treeLayout(root);

  // Draw links between nodes
  svg.selectAll('.link')
    .data(root.links())
    .enter()
    .append('path')
    .attr('class', 'link')
    .attr('d', d3.linkHorizontal()
      .x(d => d.y)
      .y(d => d.x)
    );

  // Draw node groups
  const node = svg.selectAll('.node')
    .data(root.descendants())
    .enter()
    .append('g')
    .attr('class', 'node')
    .attr('transform', d => `translate(${d.y},${d.x})`);

  // Node rectangle with tooltip events
  node.append('rect')
    .attr('width', 160)
    .attr('height', 60)
    .attr('x', -80)
    .attr('y', -30)
    .on('mouseover', (event, d) => {
      tooltip
        .style('opacity', 1)
        .html(`
          <strong>${d.data.name}</strong><br>
          Годы жизни: ${d.data.years}<br>
          Род деятельности: ${d.data.profession}<br>
          Где жил: ${d.data.residence}
        `)
        .style('left', (event.pageX + 15) + 'px')
        .style('top', (event.pageY - 20) + 'px');
    })
    .on('mousemove', event => {
      tooltip
        .style('left', (event.pageX + 15) + 'px')
        .style('top', (event.pageY - 20) + 'px');
    })
    .on('mouseout', () => {
      tooltip.style('opacity', 0);
    });

  // Primary text (name)
  node.append('text')
    .attr('dy', '-5')
    .attr('text-anchor', 'middle')
    .text(d => d.data.name);

  // Secondary text (years)
  node.append('text')
    .attr('dy', '12')
    .attr('text-anchor', 'middle')
    .attr('class', 'years')
    .attr('fill', '#666')
    .text(d => d.data.years);
});
